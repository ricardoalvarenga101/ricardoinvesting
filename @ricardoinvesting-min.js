/**
 * @preserve
 * Desenvolvimento: Ricardo Alvarenga
 * Contato: ricardoinvesting10@gmail.com
 * Youtube: https://www.youtube.com/@ricardoinvesting
 * PIX: ricardoinvesting10@gmail.com
 *             _                   _       _                     _   _             
    ____      (_)                 | |     (_)                   | | (_)            
   / __ \ _ __ _  ___ __ _ _ __ __| | ___  _ _ ____   _____  ___| |_ _ _ __   __ _ 
  / / _` | '__| |/ __/ _` | '__/ _` |/ _ \| | '_ \ \ / / _ \/ __| __| | '_ \ / _` |
 | | (_| | |  | | (_| (_| | | | (_| | (_) | | | | \ V /  __/\__ \ |_| | | | | (_| |
  \ \__,_|_|  |_|\___\__,_|_|  \__,_|\___/|_|_| |_|\_/ \___||___/\__|_|_| |_|\__, |
   \____/                                                                     __/ |
                                                                             |___/ 
 * @endpreserve
 */
const OPERATIONS={VENDA:"Venda",VENDA_DIREITOS:"Venda Direitos de Subscri√ß√£o",BONIFICACAO:"Bonifica√ß√£o em Ativos",COMPRA:"Compra",COMPRA_DIREITOS:"Compra Direitos de Subscri√ß√£o",RECIBO_DIREITOS:"Recibo de Subscri√ß√£o em Andamento"},IGNORE_TICKERS=["Op√ß√£o de Compra","Op√ß√£o de Venda","Futuro"],CLASS={ACAO:"A√ß√£o",FII:"FII",FIAGRO:"Fiagro",FI_INFRA:"FI-INFRA",BDR:"BDR",ETF:"ETF",STOCK:"STOCK",REIT:"REIT",ETF_EUA:"ETF-EXTERIOR",RENDA_FIXA:"Renda Fixa",CRIPTOMOEDA:"Criptomoeda",RENDA_FIXA_OUTROS:"Renda Fixa - Outros"},IGNORE_IMPORT_B3=["Direito de Subscri√ß√£o","Direitos de Subscri√ß√£o - N√£o Exercido","Direitos de Subscri√ß√£o - Exercida","Direitos de Subscri√ß√£o - Exercido","Cess√£o de Direitos","Cess√£o de Direitos - Solicitada","Leil√£o de Fra√ß√£o","Fra√ß√£o em Ativos","Bonifica√ß√£o em Ativos"],FLAG_PROVENTOS=["Dividendo","Juros Sobre Capital Pr√≥prio","Rendimento"],SUBSCRICOES_IDS=[12,13,14,15],LOADING_IMPORT_B3_MESSAGES={stage1:"1 - Preparando dados...",stage2:"1 - Preparando dados.</br>1.1 - Continuando de onde parou...",stage3:"1 - Preparando dados.</br>2 - Copiando dados...",stage4:"1 - Preparando dados.</br>2 - Copiando dados.</br>3 - Escrevendo dados na planilha...",stage5:"1 - Preparando dados.</br>2 - Copiando dados.</br>3 - Escrevendo dados na planilha</br>4 - Atualizando cota√ß√£o...",stage6:"1 - Preparando dados.</br>2 - Copiando dados.</br>3 - Escrevendo dados na planilha</br>4 - Atualizando cota√ß√£o.</br>5 - Por favor, aguarde..."},ABAS={INFORMACOES:"A. Informa√ß√µes",B3:"B. B3",IMPORT:"C. Importar de Outra Vers√£o",DASHBOARD:"0. Dashboard",DASHBOARD_CONSOLIDADO:"0.1. Dashboard Consolidado",MEUS_ATIVOS:"1. Meus Ativos",LANCAMENTO_B3:"2. Lan√ßamentos (B3)",LANCAMENTO_MANUAL:"2.1. Lan√ßamentos (Manual)",LANCAMENTO_CDB:"2.2. Lan√ßamentos (CDB/LCI/LCA/LC/RDB/DEB√äNTURES)",EVOLUCAO_PATRIMONIAL:"2.3. Evolu√ß√£o Patrimonial",PROVENTOS:"3. Proventos",AMORTIZACOES:"4. Amortiza√ß√µes",CALENDARIO:"5. Calend√°rio de Dividendos",BALANCEAMENTO:"6. Balanceamento da Carteira",BALANCEAMENTO_ATIVO:"6.1. Balanceamento da Carteira por Ativo",SIMULADOR_PM:"6.2. Simulador de Novo Pre√ßo M√©dio",PRECO_TETO:"7. Pre√ßo Teto",MEUS_OBJETIVOS:"8. Meus Objetivos",VENDAS:"9. Vendas",DARF:"10. DARF",BENS_DIREITOS:"11. IR Bens e Direitos",BASE_DADOS:"12. Base de Dados",TABELA_DINAMICA:"99. Tabela Dinamica",TABELA_DINAMICA_CONSOLIDADO:"99. Tabela Dinamica Consolidado",CODIGOS_IRPF:"12.1. C√≥digos IRPF",COTACAO:"99. Cota√ß√£o",ALTAS:"99. Altas e Baixas",MOVIMENTACOES_CDB:"99. Movimenta√ß√µes (CDB/LCI/LCA/LC/RDB)",MOVIMENTACOES:"99. Movimenta√ß√µes"},FRASES=["Todo processo acontece fora da zona de conforto.","Aprender a controlar seu or√ßamento √© o modo mais pr√°tico de cortar gastos e come√ßar a investir.","Investir em conhecimento rende sempre os melhores juros.","Evitar erros catastr√≥ficos √© mais importante do que construir o portf√≥lio perfeito.","Invista pensando no longo prazo, n√£o especule, mas, n√£o ignore as flutua√ß√µes do mercado.","Em vez de se preocupar com o que as pessoas dizem sobre voc√™, por que n√£o investir tempo tentando fazer algo que elas admirem?","Depois que voc√™ tem uma base s√≥lida de conhecimento, fica muito mais f√°cil aprender a investir e lidar com dinheiro.","Voc√™ precisa conquistar aquilo que o dinheiro n√£o compra. Caso contr√°rio, ser√° um miser√°vel, ainda que seja um milion√°rio.","Se voc√™ almeja ser rico, pense em poupar assim como voc√™ pensa em ganhar dinheiro.","Risco vem de voc√™ n√£o saber o que est√° fazendo. Controle o seu dinheiro.","Jamais gaste seu dinheiro antes de voc√™ possu√≠-lo.","Sucesso √© a soma de pequenos esfor√ßos, repetidos o tempo todo.","Sucesso parece ser, em grande parte, uma quest√£o de continuar depois que outros desistiram.","Eu sei o pre√ßo do sucesso: dedica√ß√£o, trabalho duro, e uma incessante devo√ß√£o √†s coisas que voc√™ quer ver acontecer.","Motiva√ß√£o √© aquilo que te faz come√ßar. H√°bito √© aquilo que te faz continuar.","A riqueza √© o resultado dos seus h√°bitos di√°rios.","O que sabemos aprendemos fazendo.","Um homem criativo √© motivado pelo desejo de alcan√ßar, n√£o pelo desejo de vencer os outros.","Tente mover o mundo ‚Äì o primeiro passo ser√° mover a si mesmo.","O insucesso √© uma oportunidade para recome√ßar com mais intelig√™ncia.","Ter problemas na vida √© inevit√°vel, ser derrotado por eles √© opcional.","A diferen√ßa entre o inteligente e o s√°bio, √© que o s√°bio pensa a longo prazo.","A verdadeira riqueza n√£o consiste em ter grandes posses, mas em ter poucas necessidades."];function deleteTrigger(){const e=ScriptApp.getProjectTriggers();for(let t=0;t<e.length;t++)ScriptApp.deleteTrigger(e[t])}function createTrigger(){deleteTrigger(),ScriptApp.newTrigger("updateCotation").timeBased().everyHours(1).create(),ScriptApp.newTrigger("getEvolutionRentability").timeBased().atHour(9).everyDays(1).create()}function getEvolutionRentability(){const e=SpreadsheetApp.getActiveSpreadsheet().getSheetByName(ABAS.DASHBOARD),t=e.getRange("A4");if([1,2,3,4,5].includes((new Date).getDay())){const a=(new Date).getHours();if(9===a||10===a){const a=composeIndiceDate(0),n=composeIndiceDate(1),o=e.getRange("A5").getValue();t.setValue(o);const r=e.getRange("E9").getValue();e.getRange("A10").setValue(r);const s=e.getRange("E11").getValue();e.getRange("A12").setValue(s);const i=e.getRange("E13").getValue();e.getRange("A14").setValue(i);const g=e.getRange("E15").getValue();e.getRange("A16").setValue(g);const c=e.getRange("E17").getValue();e.getRange("A18").setValue(c);const A=e.getRange("E19").getValue();e.getRange("A20").setValue(A);const u=e.getRange("E21").getValue();e.getRange("A22").setValue(u);const l=e.getRange("E23").getValue();e.getRange("A24").setValue(l);const S=e.getRange("E26").getValue();e.getRange("A27").setValue(S);const d=e.getRange("E28").getValue();e.getRange("A29").setValue(d);const m=e.getRange("E30").getValue();e.getRange("A31").setValue(m),a>n&&updatePerformance(o)}}}function updateCotation(){const e=[CLASS.ETF_EUA,CLASS.REIT,CLASS.STOCK],t=SpreadsheetApp.getActiveSpreadsheet();let a=0;const n=t.getSheetByName(ABAS.COTACAO);Utilities.sleep(1e3),a=getTotalRegisterInGuide(n);for(var o=2;o<=a+1;o++){n.getRange(o,1).getValue();const t=n.getRange(o,2).getValue();let a=n.getRange(o,3).getValue();const r=String("D")+o,s=(String("E"),n.getRange(r));if("-"!==a)if(e.includes(t)){const e=n.getRange("F2").getValue();s.setValue(a*e)}else s.setValue(a)}const r=t.getSheetByName(ABAS.DASHBOARD),s=Utilities.formatDate(new Date,"GMT-3","dd/MM/yyyy-HH:mm:ss");r.getRange("b4").setValue("üïî Data da √∫ltima cota√ß√£o: "+s),r.getRange("a3").setValue((new Date).toTimeString());const i=t.getSheetByName(ABAS.TABELA_DINAMICA),g=new Date;i.getRange("AP2").setValue(g.getMilliseconds()+g.getSeconds()+g.getMinutes())}function updateCotationManual(){const e=HtmlService.createHtmlOutput("<script>google.script.host.close();<\/script>"),t=SpreadsheetApp.getUi();t.showSidebar(HtmlService.createHtmlOutputFromFile("@ricardoinvesting-cotation-html").setTitle("Atualizando cota√ß√µes")),updateCotation(),t.showSidebar(e.setTitle("Atualizando cota√ß√µes"))}function formatCNPJ(e){if(-1!==e.indexOf("F")){return e.substr("F",20).trim().slice(2,20)}return e}function updatePerformance(e){const t=SpreadsheetApp.getActiveSpreadsheet().getSheetByName(ABAS.EVOLUCAO_PATRIMONIAL),a=t.getRange("Z1").getValue()+2;t.getRange(`G${a}`).setValue(e)}function hidden(){const e=SpreadsheetApp.getActiveSpreadsheet().getSheetByName(ABAS.DASHBOARD);let t=e.getRange("A1").getValue()||-1;t*=-1,e.getRange("A1").setValue(t)}function getFrases(e){const t=Math.floor(Math.random()*FRASES.length);return FRASES[t]}function checkVersion(e,t){try{const a=getCache(e,"message");if(a)return a;const n=UrlFetchApp.fetch("https://bombolao-v2.rj.r.appspot.com/core/api/version/message"),o=JSON.parse(n.getContentText());return e!==o.currentVersion?(setCache(e,o,!0,60),o.message):getFrases(t)}catch{return getFrases(t)}}const PRINT_OPTIONS={size:7,fzr:!1,portrait:!1,fitw:!0,gridlines:!1,printtitle:!1,sheetnames:!1,pagenum:"UNDEFINED",attachment:!1},PDF_OPTS=objectToQueryString(PRINT_OPTIONS);function onOpen(){const e=SpreadsheetApp.getUi().createMenu("[@ricardoinvesting]");e.addSubMenu(SpreadsheetApp.getUi().createMenu("üîπ B3").addItem("Importar Lan√ßamentos da B3","importarDadosB3")),e.addSubMenu(SpreadsheetApp.getUi().createMenu("üîπ Acionadores").addItem("Criar Acionadores","createTrigger").addSeparator().addItem("‚õî Remover Acionadores","createTrigger")),e.addItem("üîπ Lan√ßamentos","showReleases"),e.addSubMenu(SpreadsheetApp.getUi().createMenu("üîπ Automa√ß√µes Interessantes").addItem("Atualizar Cota√ß√£o","updateCotationManual").addItem("Exibir/Esconder Valores","hidden").addItem("Exibir Apenas Abas Principais","onlyTabsDefault").addSeparator().addItem("‚õî Resetar Planilha","clearAll")),e.addSeparator(),e.addItem("üîπ IRPF","showIR"),e.addToUi();const t=SpreadsheetApp.getActiveSpreadsheet().getSheetByName(ABAS.TABELA_DINAMICA),a=new Date;t.getRange("AP2").setValue(a.getMilliseconds()+a.getSeconds()+a.getMinutes())}function clearAll(){const e=SpreadsheetApp.getUi();if(e.alert("Aten√ß√£o! Deseja realmente limpar a planilha? Esta a√ß√£o √© irrevers√≠vel.",e.ButtonSet.YES_NO)===e.Button.YES){const e=SpreadsheetApp.getActiveSpreadsheet(),t=e.getSheetByName(ABAS.B3);t.getRange("I3").clearContent(),t.getRange("J2").setValue(0);const a=e.getSheetByName(ABAS.LANCAMENTO_B3);a.getRange("C2:E").clearContent(),a.getRange("I2:L").clearContent(),a.getRange("P2:P").clearContent(),a.getRange("R2:R").setValue(!1),a.getRange("S2:S").clearContent();const n=e.getSheetByName(ABAS.LANCAMENTO_MANUAL);n.getRange("C2:E").clearContent(),n.getRange("I2:L").clearContent(),n.getRange("P2:P").clearContent(),n.getRange("R2:R").setValue(!1),n.getRange("S2:S").clearContent();const o=e.getSheetByName(ABAS.PROVENTOS);o.getRange("B4:E").clearContent(),o.getRange("G4:I").clearContent();const r=e.getSheetByName(ABAS.EVOLUCAO_PATRIMONIAL);r.getRange("D2:E").clearContent(),r.getRange("G2:G").clearContent();const s=e.getSheetByName(ABAS.VENDAS);s.getRange("B4:C").clearContent(),s.getRange("H4:M").clearContent();const i=e.getSheetByName(ABAS.COTACAO);i.getRange("D2:D").clearContent(),i.getRange("E2:E").clearContent();const g=e.getSheetByName(ABAS.DARF);g.getRange("C18:C23").setValue(0),g.getRange("K18:K24").setValue(0);const c=e.getSheetByName(ABAS.MEUS_OBJETIVOS);c.getRange("B2:B21").setValue("PENDENTE"),c.getRange("E2:E21").setValue("-");const A=e.getSheetByName(ABAS.PRECO_TETO);A.getRange("B4:B105").clearContent(),A.getRange("G4:G105").clearContent(),A.getRange("H4:H105").clearContent();const u=e.getSheetByName(ABAS.BALANCEAMENTO_ATIVO);u.getRange("B4:B103").clearContent(),u.getRange("G4:G103").clearContent();const l=e.getSheetByName(ABAS.BALANCEAMENTO);l.getRange("B4:B103").clearContent(),l.getRange("G4:G103").clearContent();const S=e.getSheetByName(ABAS.AMORTIZACOES);S.getRange("A2:A").clearContent(),S.getRange("B4:B").clearContent(),S.getRange("C4:C").clearContent();e.getSheetByName(ABAS.SIMULADOR_PM).getRange("J4:L").clearContent();e.getSheetByName(ABAS.LANCAMENTO_CDB).getRange("C2:J").clearContent();e.getSheetByName(ABAS.IMPORT).getRange("D5:D19").setValue(!1);return e.getSheetByName(ABAS.BENS_DIREITOS).getRange("AC2").clearContent(),Browser.msgBox("Reset realizado com sucesso!")}}function onlyTabsDefault(){const e=SpreadsheetApp.getActiveSpreadsheet();e.getSheetByName(ABAS.INFORMACOES).showSheet(),e.getSheetByName(ABAS.B3).showSheet(),e.getSheetByName(ABAS.DASHBOARD).showSheet(),e.getSheetByName(ABAS.MEUS_ATIVOS).showSheet(),e.getSheetByName(ABAS.LANCAMENTO_B3).showSheet(),e.getSheetByName(ABAS.LANCAMENTO_MANUAL).showSheet(),e.getSheetByName(ABAS.VENDAS).showSheet(),e.getSheetByName(ABAS.DARF).showSheet(),e.getSheetByName(ABAS.PROVENTOS).showSheet(),e.getSheetByName(ABAS.DASHBOARD_CONSOLIDADO).showSheet(),e.getSheetByName(ABAS.LANCAMENTO_CDB).hideSheet(),e.getSheetByName(ABAS.EVOLUCAO_PATRIMONIAL).hideSheet(),e.getSheetByName(ABAS.AMORTIZACOES).hideSheet(),e.getSheetByName(ABAS.CALENDARIO).hideSheet(),e.getSheetByName(ABAS.BALANCEAMENTO).hideSheet(),e.getSheetByName(ABAS.BALANCEAMENTO_ATIVO).hideSheet(),e.getSheetByName(ABAS.SIMULADOR_PM).hideSheet(),e.getSheetByName(ABAS.PRECO_TETO).hideSheet(),e.getSheetByName(ABAS.MEUS_OBJETIVOS).hideSheet(),e.getSheetByName(ABAS.BENS_DIREITOS).hideSheet(),e.getSheetByName(ABAS.BASE_DADOS).hideSheet(),e.getSheetByName(ABAS.TABELA_DINAMICA).hideSheet(),e.getSheetByName(ABAS.TABELA_DINAMICA_CONSOLIDADO).hideSheet(),e.getSheetByName(ABAS.CODIGOS_IRPF).hideSheet(),e.getSheetByName(ABAS.COTACAO).hideSheet(),e.getSheetByName(ABAS.ALTAS).hideSheet(),e.getSheetByName(ABAS.MOVIMENTACOES).hideSheet(),e.getSheetByName(ABAS.MOVIMENTACOES_CDB).hideSheet(),e.getSheetByName(ABAS.IMPORT).hideSheet()}function printSelectedRange(){SpreadsheetApp.flush();const e=SpreadsheetApp.getActiveSpreadsheet(),t=e.getActiveSheet(),a=SpreadsheetApp.getActiveSpreadsheet().getSheetByName(ABAS.BENS_DIREITOS),n=t.getRange("F3:W103"),o=a.getSheetId(),r=objectToQueryString({c1:n.getColumn()-1,r1:n.getRow()-1,c2:n.getColumn()+n.getWidth()-1,r2:n.getRow()+n.getHeight()-1}),s=e.getUrl().replace(/edit$/,"")+"export?format=pdf"+PDF_OPTS+r+"&gid="+o,i=HtmlService.createTemplateFromFile("@ricardoinvesting-html");i.url=s,SpreadsheetApp.getUi().showModalDialog(i.evaluate().setHeight(10).setWidth(100),"Preparando impress√£o...")}function objectToQueryString(e){return Object.keys(e).map((function(t){return Utilities.formatString("&%s=%s",t,e[t])})).join("")}function TESOURODIRETO(e=1){try{let e="https://www.tesourodireto.com.br/json/br/com/b3/tesourodireto/service/api/treasurybondsinfo.json",t=UrlFetchApp.fetch(e),a=JSON.parse(t.getContentText()).response,n={};return a.TrsrBdTradgList.forEach((e=>{const t=e.TrsrBd.nm;n[t.toUpperCase()]=e.TrsrBd.untrInvstmtVal})),JSON.stringify(n)}catch(e){}}function getTesouro(e="TESOURO PREFIXADO 2025"){const t=getTesouroService(e);if(t)return t;throw new Error("Not Found")}function getTesouroService(e,t=null){try{const t=getCache(e,"value");if(t)return t;const a=UrlFetchApp.fetch(`https://bombolao-v2.rj.r.appspot.com/core/api/cotation?ticker=${e}`),n=JSON.parse(a.getContentText());return setCache(e,n,n&&"value"in n,25),n.value}catch{throw new Error("Not Found")}}function TESOURODIRETO(e=1){try{let e="https://www.tesourodireto.com.br/json/br/com/b3/tesourodireto/service/api/treasurybondsinfo.json",t=UrlFetchApp.fetch(e),a=JSON.parse(t.getContentText()).response,n={};return a.TrsrBdTradgList.forEach((e=>{const t=e.TrsrBd.nm;n[t.toUpperCase()]=e.TrsrBd.untrInvstmtVal})),JSON.stringify(n)}catch(e){}}function getTesouro(e="TESOURO PREFIXADO 2025"){const t=getTesouroService(e);if(t)return t;throw new Error("Not Found")}function getTesouroService(e,t=null){try{const t=getCache(e,"value");if(t)return t;const a=UrlFetchApp.fetch(`https://bombolao-v2.rj.r.appspot.com/core/api/cotation?ticker=${e}`),n=JSON.parse(a.getContentText());return setCache(e,n,n&&"value"in n,25),n.value}catch{throw new Error("Not Found")}}function composeNode(e,t,a){return e.hasOwnProperty(t)?e[t]+=a:e={...e,[t]:a},e}function isExternal(e){return[CLASS.ETF_EUA,CLASS.STOCK,CLASS.REIT].includes(e)}function composeCurrencyReal(e){return e.toLocaleString("pt-br",{minimumFractionDigits:2,style:"currency",currency:"BRL"})}function calculateAverage(e){return e.reduce(((e,t)=>e+t),0)/e.length}function getSheetId(e,t=null){return SpreadsheetApp.getActiveSpreadsheet().getSheetByName(ABAS.DASHBOARD_CONSOLIDADO).getSheetId()}function getRenderType(e,t){switch(e){case"A√ß√£o":case"ETF":case"ETF-EXTERIOR":case"STOCK":case"REIT":return isMany(t)?"A√á√ïES":"A√á√ÉO";break;case"FII":case"FI-INFRA":case"Fiagro":return isMany(t)?"COTAS":"COTA";break;default:return isMany(t)?"UNIDADES":"UNIDADE";break}}function isMany(e){return e>1}function getDataRange(e,t,a,n,o,r){const s=e.getLastRow(),i=s-e.getRange(t+a+":"+t+s).getValues().reverse().findIndex((e=>""!=e[0]));return e.getRange(n+o+":"+r+i).getValues()}function getDataRangeLimit(e,t,a,n,o){return e.getRange(t+a+":"+n+o).getValues()}function getLastRowInTable(e,t,a){const n=e.getLastRow();return n-e.getRange(t+a+":"+t+n).getValues().reverse().findIndex((e=>""!=e[0]))}function validaValor(e){return"-"===e?0:"string"==typeof e&&-1!=e.indexOf("R")?e.slice(2,e.length):e}function retornaTickerName(e,t){let a=[{}],n="";return a=e.split(t),n=a[0],n.toUpperCase()}function closeModal(e){e.showModelessDialog(HtmlService.createHtmlOutput('<!DOCTYPE html><html><head><base target="_top"></head><script>window.onload=()=>{google.script.host.close();}<\/script><body></body></html>'),"Importa√ß√£o realizada com sucesso!")}function newImportB3(){const e=SpreadsheetApp.getUi(),t=SpreadsheetApp.getActiveSpreadsheet().getSheetByName(ABAS.B3),a=t.getRange("A3:H");return e.alert(`Preparar para novos lan√ßamentos, esteja ciente de que ao confirmar iremos apagar todos os dados na aba "${ABAS.B3}", certifique-se de verificar a ultima data de lan√ßamentos para n√£o ter problemas de duplicidade ou falta de lan√ßamentos, deseja realmente continuar este processo √© irrevers√≠vel?`,e.ButtonSet.YES_NO)===e.Button.YES?(t.getRange("J2").setValue(0),a.setBackground("white"),a.clearContent(),Browser.msgBox("Tudo pronto para copiar os dados e seguir com procedimento de importa√ß√£o, bons investimentos!")):Browser.msgBox("Prepara√ß√£o cancelada!")}function composeIndiceDate(e=1){let t=new Date((new Date).setDate((new Date).getDate()-e));const a=[1,2,3,4,5];if(0!==e&&-1!==e)for(let e=1;e<=5&&(t=new Date((new Date).setDate((new Date).getDate()-e)),!a.includes(t.getDay()));e++);const n=t.getFullYear();let o=t.getMonth()+1;o<10&&(o=String(0)+o);return`${n}${o}`}function getTotalRegisterInGuide(e){let t=0,a=0;for(a=2;0==e.getRange(a,1).isBlank();)t+=1,a+=1;return t}function setCache(e,t,a,n=5){const o=CacheService.getScriptCache();a&&o.put(e,JSON.stringify(t),60*n)}function getCache(e,t){const a=CacheService.getScriptCache().get(e);if(null!==a){return JSON.parse(a)[t]}}function removeCache(e){CacheService.getScriptCache().remove(e)}function importarDadosB3(){const e=HtmlService.createHtmlOutput("<script>google.script.host.close();<\/script>"),t="Importando lan√ßamentos da B3";const a=SpreadsheetApp.getUi(),n=SpreadsheetApp.getActiveSpreadsheet(),o=n.getSheetByName(ABAS.B3),r=n.getSheetByName(ABAS.LANCAMENTO_B3),s=n.getSheetByName(ABAS.PROVENTOS),i=o.getRange("I2").getValue(),g=o.getRange("J2").getValue()||0;a.showModalDialog(HtmlService.createHtmlOutput(LOADING_IMPORT_B3_MESSAGES.stage1),t);const c=o.getRange("L2").getValue(),A=o.getRange("K2").getValue();let u=250,l=Number(o.getRange("I3").getValue()||0);const S=new Array,d=new Array;if(!l){o.getRange("B2:B").activate(),o.getActiveRangeList().setNumberFormat("dd/MM/yyyy");const e="A2:H";let t=o.getRange(e).getFilter();t||(t=o.getRange(e).createFilter()),o.getRange("B2").activate(),t.sort(2,!0),t.remove()}let m=i/u;const p=m-parseInt(m),R=Math.round(p*u);g==m&&(u=R);let h=getDataRangeLimit(o,"A",l||l+3,"H",l+u+(l?-1:3));const O=h.length;if(!l&&l+u<i){if(a.alert(`Aten√ß√£o! Existem muitos lan√ßamentos a serem importados, eles ser√£o feitos em lotes de ${u}. Fique tranquilo, voc√™ ser√° avisado de todo andamento e lembre-se:\r\n\r\n - N√£o ser√£o importados dados de subscri√ß√µes \r\n - N√£o ser√£o importados dados de bonifica√ß√µes \r\n - N√£o ser√£o ajustados altera√ß√µes de nomeclaturas \r\n - N√£o ser√£o ajustados agrupamentos e/ou desdobramentos \r\n - Renda fixa, compatibilidade apenas com Tesouro Direto \r\n\n Esta de acordo?`,a.ButtonSet.YES_NO)!==a.Button.YES)return a.showModalDialog(e,t),null}if(l>=i)return Browser.msgBox("üí∞ Lan√ßamentos j√° foram importados!"),a.showModalDialog(e,t);a.showModalDialog(HtmlService.createHtmlOutput(LOADING_IMPORT_B3_MESSAGES.stage3),t);for(var E=0;E<=O-1;E++){const e=new Array;e[0]=retornaTickerName(h[E][3],"-").trim(),e[3]=h[E][2];const t=parseInt(e[0].replace(/\D/g,""));SUBSCRICOES_IDS.includes(t)||IGNORE_IMPORT_B3.includes(e[3])||IGNORE_TICKERS.includes(e[0])||(e[1]=h[E][0],e[2]=h[E][1],e[4]=h[E][4],e[5]=validaValor(h[E][5]),e[6]=validaValor(h[E][6]),e[7]=validaValor(h[E][7]),FLAG_PROVENTOS.includes(e[3])?("Juros Sobre Capital Pr√≥prio"===e[3]&&(e[3]="JCP"),d.push(e)):("Bonifica√ß√£o em Ativos"!==e[3]&&("Debito"===e[1]?e[3]="Venda":"Credito"===e[1]&&(e[3]="Compra")),S.push(e)))}let B=A;a.showModalDialog(HtmlService.createHtmlOutput(LOADING_IMPORT_B3_MESSAGES.stage4),t);for(var D=0;D<S.length;D++)r.getRange(B,3).setValue(S[D][0]),r.getRange(B,4).setValue(S[D][2]),r.getRange(B,5).setValue(S[D][3]),r.getRange(B,9).setValue(S[D][5]),r.getRange(B,10).setValue(S[D][6]),B+=1;let N=c;for(D=0;D<d.length;D++)s.getRange(N,2).setValue(d[D][0]),s.getRange(N,3).setValue(d[D][3]),s.getRange(N,4).setValue(d[D][2]),s.getRange(N,5).setValue(d[D][5]),s.getRange(N,7).setValue(d[D][7]),N+=1;const C=l?l+u:l+u+3;o.getRange("I3").setValue(C);const I=C>i?i+3:C;if(o.getRange("A3:H"+I).setBackground("yellow"),o.getRange("J2").setValue(Number(g)+1),!(C<i))return a.showModalDialog(HtmlService.createHtmlOutput(LOADING_IMPORT_B3_MESSAGES.stage5),t),o.getRange("I3").clearContent(),a.showModalDialog(HtmlService.createHtmlOutput(LOADING_IMPORT_B3_MESSAGES.stage6),t),updateCotationManual(),Browser.msgBox("üí∞ Lan√ßamentos importados com sucesso!"),a.showModalDialog(e,t);{let n=a.alert(`(${u}) Lan√ßamentos processados, ainda restam ${i-(C-2)} deseja continuar?`,a.ButtonSet.YES_NO);if(n===a.Button.YES)return Browser.msgBox("Por favor, execute novamente o script para continuar de onde parou."),a.showModalDialog(e,t);if(n===a.Button.NO)return Browser.msgBox("Movimenta√ß√µes importadas parcialmente! Por favor, execute novamente o script para continuar de onde parou."),a.showModalDialog(e,t)}}const CLASS_EXTERNAL_LIST=[CLASS.ETF_EUA,CLASS.STOCK,CLASS.REIT],CLASS_FIXED_LIST=[CLASS.RENDA_FIXA],CLASS_ACOES_LIST=[CLASS.ACAO,CLASS.ETF];function composeDescription(e,t,a,n,o,r,s,i,g=1){try{const c=s,A=i;if(CLASS_EXTERNAL_LIST.includes(e))return`(${t}) - ${a} ${getRenderType(e,a)} DE ${n.toUpperCase()}, C√ìDIGO DE NEGOCIA√á√ÉO: ${t}. PRE√áO M√âDIO DE ${r} ${c} E CUSTO TOTAL DE AQUISI√á√ÉO DE ${r} ${A} - (C√ÇMBIO DE R$ ${g.toFixed(4)})`;if(CLASS_FIXED_LIST.includes(e))return`APLICA√á√ÉO EM ${n.toUpperCase()} NO CNPJ: ${o} TOTALIZANDO ${a} ${getRenderType(e,a)}, COM CUSTO TOTAL DE AQUISI√á√ÉO DE ${r} ${A}`;{const s=parseInt(t.replace(/\D/g,""));return SUBSCRICOES_IDS.includes(s)?a<=1?`(${t}) - ${a} RECIBO DE SUBSCRI√á√ÉO DE ${n.toUpperCase()}, CNPJ: ${o}, C√ìDIGO DE NEGOCIA√á√ÉO: ${t}. PRE√áO M√âDIO DE ${r} ${c} E CUSTO TOTAL DE AQUISI√á√ÉO DE ${r} ${A}`:`(${t}) - ${a} RECIBOS DE SUBSCRI√á√ïES DE ${n.toUpperCase()}, CNPJ: ${o}, C√ìDIGO DE NEGOCIA√á√ÉO: ${t}. PRE√áO M√âDIO DE ${r} ${c} E CUSTO TOTAL DE AQUISI√á√ÉO DE ${r} ${A}`:`(${t}) - ${a} ${getRenderType(e,a)} DE ${n.toUpperCase()}, CNPJ: ${o}, C√ìDIGO DE NEGOCIA√á√ÉO: ${t}. PRE√áO M√âDIO DE ${r} ${c} E CUSTO TOTAL DE AQUISI√á√ÉO DE ${r} ${A}`}}catch{return"-"}}function composeSells(e=2023,t={}){const a=getDataRange(SpreadsheetApp.getActiveSpreadsheet().getSheetByName(ABAS.VENDAS),"B",4,"B",4,"S");let n={};for(let e=0;e<=a.length-1;e++){const o=a[e][0];if(!o)return n;const r=new Date(a[e][11]).getFullYear(),s=new Date(a[e][11]).getMonth()+1;n.hasOwnProperty(r)?s in n[r]?n[r][s].operations.push({operation:a[e][1],transaction:a[e][13],value:a[e][17],ticker:o,name:a[e][2],classe:a[e][3],type:a[e][5],document_number_principal:t[o].document_number_principal,document_number_admin:t[o].document_number_admin}):n[r][s]={operations:[{operation:a[e][1],transaction:a[e][13],value:a[e][17],ticker:o,name:a[e][2],classe:a[e][3],type:a[e][5],document_number_principal:t[o].document_number_principal,document_number_admin:t[o].document_number_admin}]}:n[r]={[s]:{operations:[{operation:a[e][1],transaction:a[e][13],value:a[e][17],ticker:o,name:a[e][2],classe:a[e][3],type:a[e][5],document_number_principal:t[o].document_number_principal,document_number_admin:t[o].document_number_admin}]}}}return n}function hasReceiverDividendsThisYear(e=2023,t,a="@ricardoinvesting"){try{let n=!1;for(let o=0;o<=t.length-1;o++){const r=t[o][1],s=new Date(t[o][3]).getFullYear();if(n=!1,s===e&&r===a){n=!0;break}}return n}catch(e){return!1}}function composeProvents(e=2023,t={}){try{const a=SpreadsheetApp.getActiveSpreadsheet(),n=getDataRange(a.getSheetByName(ABAS.PROVENTOS),"B",4,"A",4,"Q");let o={};for(let a=0;a<=n.length-1;a++){const r=n[a][1];if(!r)return o;const s=new Date(n[a][3]).getFullYear(),i=new Date(n[a][14]).getMonth();if(s===e){const e=CLASS_EXTERNAL_LIST.includes(n[a][16]);switch(o.hasOwnProperty(r)||(e?o.hasOwnProperty("external")?o.external.hasOwnProperty(r)||(o.external[r]={dividends:[],amountDividend:0,jcp:[],amountJcp:0,rendiments:[],amountRendiment:0,rendimentJCP:[],amountRendimentJCP:0,name:t[r].name,document_number_principal:t[r].document_number_principal,document_number_admin:t[r].document_number_admin,amountTax:0,dividendPerMonth:{},taxPerMonth:{},cambioMonth:{},amountMonth:{}}):o.external={[r]:{dividends:[],amountDividend:0,jcp:[],amountJcp:0,rendiments:[],amountRendiment:0,rendimentJCP:[],amountRendimentJCP:0,name:t[r].name,document_number_principal:t[r].document_number_principal,document_number_admin:t[r].document_number_admin,amountTax:0,dividendPerMonth:{},taxPerMonth:{},cambioMonth:{},amountMonth:{}}}:o[r]={dividends:[],amountDividend:0,jcp:[],amountJcp:0,rendiments:[],amountRendiment:0,rendimentJCP:[],amountRendimentJCP:0,name:t[r].name,document_number_principal:t[r].document_number_principal,document_number_admin:t[r].document_number_admin}),n[a][2]){case"Dividendo":e?(o.external[r].dividends.push(n[a][10]),o.external[r].amountDividend+=n[a][10],o.external[r].amountTax+=n[a][12],o.external[r].dividendPerMonth=composeNode(o.external[r].dividendPerMonth,i,n[a][11]),o.external[r].taxPerMonth=composeNode(o.external[r].taxPerMonth,i,n[a][12]),o.external[r].cambioMonth=composeNode(o.external[r].cambioMonth,i,n[a][8]),o.external[r].amountMonth=composeNode(o.external[r].amountMonth,i,n[a][9])):(o[r].dividends.push(n[a][10]),o[r].amountDividend+=n[a][10]);break;case"Rendimento":CLASS_ACOES_LIST.includes(n[a][16])?(o[r].rendimentJCP.push(n[a][10]),o[r].amountRendimentJCP+=n[a][10]):e?(o.external[r].rendiments.push(n[a][10]),o.external[r].amountRendiment+=n[a][10],o.external[r].dividendPerMonth=composeNode(o.external[r].dividendPerMonth,i,n[a][11]),o.external[r].taxPerMonth=composeNode(o.external[r].taxPerMonth,i,n[a][12]),o.external[r].cambioMonth=composeNode(o.external[r].cambioMonth,i,n[a][8]),o.external[r].amountMonth=composeNode(o.external[r].amountMonth,i,n[a][9])):(o[r].rendiments.push(n[a][10]),o[r].amountRendiment+=n[a][10]);break;case"JCP":e||(o[r].jcp.push(n[a][10]),o[r].amountJcp+=n[a][10]);break}}}return o}catch(e){return e}}function getDataBase(){const e=getDataRange(SpreadsheetApp.getActiveSpreadsheet().getSheetByName(ABAS.BASE_DADOS),"A",4,"A",1,"J");let t={};const a=[];for(let n=3;n<=e.length-1;n++){const o=e[n][0],r=e[n][8];t[o]={name:e[n][1],document_number_principal:e[n][3],document_number_admin:e[n][4],classe:r},r!==CLASS.RENDA_FIXA_OUTROS&&r!==CLASS.CRIPTOMOEDA&&a.push(o)}return t={...t,tickers:a},t}function getFirstYear(){const e=getDataRange(SpreadsheetApp.getActiveSpreadsheet().getSheetByName(ABAS.MOVIMENTACOES),"D",2,"D",2,"D");let t=(new Date).getFullYear();return e[0][0]&&(t=e[0][0]),new Date(t).getFullYear()}function calculateAmmountIRPFFull(e=2023,t="",a=!1){try{const t=SpreadsheetApp.getActiveSpreadsheet(),n=getDataRange(t.getSheetByName(ABAS.MOVIMENTACOES),"C",2,"A",2,"V"),o=[],r={};for(let t=0;t<=n.length-1;t++){const s=n[t][2],i=new Date(n[t][3]).getFullYear(),g=new Date(n[t][3]).toISOString();if(i<=e){let i=a?14:9;(new Date).getFullYear()>e&&(i=14),o.includes(s)?r[s].movimentations.push({data:g,typeOperation:n[t][4],qtd:n[t][5],cambio:""===n[t][15]||"-"===n[t][15]?0:n[t][15],investedAmount:n[t][i]}):(r[s]={movimentations:[{data:g,typeOperation:n[t][4],qtd:n[t][5],cambio:""===n[t][15]||"-"===n[t][15]?0:n[t][15],investedAmount:n[t][i]}]},o.push(s))}}const s=SpreadsheetApp.getActiveSpreadsheet(),i=getDataRange(s.getSheetByName(ABAS.PROVENTOS),"B",4,"A",4,"Q"),g={};Object.keys(r).forEach((t=>{const a=r[t].movimentations.sort(((e,t)=>e.data<t.data?-1:e.data>t.data?1:0)),n={};a.forEach((function(e){const t=n[e.data];t?t.push(e):n[e.data]=[e]}));const o=Object.keys(n);let s=0,c=0,A=null,u=[];o.forEach((e=>{n[e].forEach((e=>{const t=e.typeOperation,a=e.qtd,n=e.investedAmount;if(t===OPERATIONS.BONIFICACAO||t===OPERATIONS.COMPRA||t===OPERATIONS.COMPRA_DIREITOS||t===OPERATIONS.RECIBO_DIREITOS)c+=n,s+=a,u.push(Number("-"===e.cambio?0:e.cambio));else if(t===OPERATIONS.VENDA||t===OPERATIONS.VENDA_DIREITOS){const t=s-a;c=c/s*t,s=t,A=new Date(e.data).getFullYear()}}))}));const l=hasReceiverDividendsThisYear(e,i,t);g[t]={accumulatedTotal:s,accumulatedInvested:c,lastYearSales:A,cambio:u,averageCambio:0,hasDividends:l}}));const c=[];return Object.keys(g).forEach((t=>{(null===g[t].lastYearSales||g[t].lastYearSales===e||g[t].accumulatedTotal>0||g[t].hasDividends)&&c.push(t),g[t].averageCambio=calculateAverage(g[t].cambio)})),JSON.stringify({...g,snapshotToYear:c})}catch{return"-"}}function getAmmount(e,t,a=!1){try{const n=JSON.parse(e);if(t in n){const e=n[t].accumulatedInvested;if(a){const e=n[t].accumulatedTotal;return e<0?0:e}return e<0?0:e}return 0}catch{return"-"}}function getWallet(e,t=null){try{const t=JSON.parse(e);let a=[];return t?(t.snapshotToYear.forEach((e=>{const n=t[e].accumulatedTotal,o=t[e].hasDividends;(n>0||o)&&a.push(e)})),a.sort()):[]}catch{return[]}}function calculateIRPFProgressive(e,t,a){try{let a=22.5;const n=Number(e);return a=n<180?22.5:n>=181&&n<=360?20:n>=361&&n<=720?17.5:15,t*(a/100)}catch{return 0}}function composeCurrency(e,t,a=2){const n=isExternal(t)?"en":"pt-br";return"en"===n?e.toLocaleString(n,{minimumFractionDigits:a,style:"currency",currency:"USD"}):e.toLocaleString(n,{minimumFractionDigits:a,style:"currency",currency:"BRL"})}function composeBensEDireitos(e,t,a,n){const o=JSON.parse(t),r=JSON.parse(a),s=n,i=[];return e.forEach((e=>{const t=o[e].accumulatedInvested/o[e].accumulatedTotal,a=e in s?s[e].document_number_principal:"",n=e in s?s[e].document_number_admin:"",g=e in s?s[e].classe:"",c=e in s?s[e].name:"";let A=e in s?composeDescription(g,e,o[e].accumulatedTotal,c,n||a,"##",composeCurrency(t,g),composeCurrency(o[e].accumulatedInvested,g),o[e].averageCambio):"";A=A.replaceAll("## ",""),i.push({ticker:e,classe:g,name:c,document_number_principal:a,document_number_admin:n,qtd:o[e].accumulatedTotal,pm:composeCurrency(t,o[e].classe),investiment:composeCurrency(o[e].accumulatedInvested,o[e].classe),past_year:composeCurrencyReal(e in r?r[e].accumulatedInvested*(r[e].averageCambio||1):0),this_year:composeCurrencyReal(o[e].accumulatedInvested*(o[e].averageCambio||1)),description:A,averageCambio:composeCurrency(o[e].averageCambio,o[e].classe)})})),i}function irReportLoadingData(e=2022,t=!1,a=!0){const n=getDataBase(),o=composeSells(e,n),r=calculateAmmountIRPFFull(e,"",t),s=calculateAmmountIRPFFull(e-1,"",a);return{itensWallletFiltered:composeBensEDireitos(getWallet(r,""),r,s,n),provents:composeProvents(Number(e),n),sells:o}}function showIR(){try{const e="IRPF - RELAT√ìRIO ANUAL",t=SpreadsheetApp.getUi(),a=HtmlService.createTemplateFromFile("@ricardoinvesting-showIR").evaluate();t.showSidebar(a.setTitle(e))}catch(e){throw new Error(`N√£o foi poss√≠vel gerar o relat√≥rio. ::erro!:: ${e}`)}}function copyData(e,t,a,n,o,r,s,i,g,c,A,u,l){const S=Number(e.getRange("M17").getValue());let d,m,p,R,h=0,O=0,E=0,B=0,D=0,N=1,C=0;if(!1===e.getRange(t).getValue()&&a===l){if(i===ABAS.BASE_DADOS&&c.getSheetByName(i).getRange("A4:J").clearContent(),O=e.getRange(s).getValue(),d=g.getSheetByName(i),O&&""!==O&&"0"!==O)E=Number(O.split("/")[0]),h=Number(O.split("/")[1]),B=E+(n-1)+S,D=B>h?h-E:S,N=D,p=d.getRange(E+n,o,N,r).getValues(),c.getSheetByName(i).getRange(E+n,o,N,r).setValues(p),E+=N;else{if(m=d.getLastRow(),p=d.getRange(n,A,m,1).getValues(),C=p.reverse().findIndex((e=>""!==e[0])),R=m-(-1===C?m:C),0===R)return e.getRange(t).setValue(!0),e.getRange(s).setValue("0/0"),null;R-n>S?(p=d.getRange(n,o,S,r).getValues(),E=S):(p=d.getRange(n,o,R,r).getValues(),E=R),h=R,c.getSheetByName(i).getRange(n,o,E,r).setValues(p)}u||E!==h?u||E===h||e.getRange(s).setValue(`${E}/${h}`):(e.getRange(t).setValue(!0),e.getRange(s).setValue(`${E}/${h}`))}}function importDataOtherVersion(e=null){const t="Migrando dados de outra vers√£o",a=HtmlService.createHtmlOutput("<script>google.script.host.close();<\/script>"),n=SpreadsheetApp.getUi();if(n.alert("Aten√ß√£o! Voc√™ deseja realmente importar dados de outra planilha?\n\nTenha certeza de que a planilha que receber√° os dados esteja totalmente limpa. Deseja continuar?",n.ButtonSet.YES_NO)===n.Button.YES)try{const o=HtmlService.createHtmlOutputFromFile("@ricardoinvesting-import-html");n.showSidebar(o.setTitle(t));const r=SpreadsheetApp.getActiveSpreadsheet(),s=r.getSheetByName(ABAS.IMPORT),i=s.getRange("C2").getValue(),g=SpreadsheetApp.openByUrl(i);let c,A,u,l;copyData(s,"D5",1,4,1,10,"E5",ABAS.BASE_DADOS,g,r,2,!1,e),!1===s.getRange("D6").getValue()&&1===e&&(c=g.getSheetByName(ABAS.DASHBOARD),A=c.getRange("A4").getValues(),r.getSheetByName(ABAS.DASHBOARD).getRange("A4").setValues(A),A=c.getRange("A10").getValues(),r.getSheetByName(ABAS.DASHBOARD).getRange("A10").setValues(A),A=c.getRange("A12").getValues(),r.getSheetByName(ABAS.DASHBOARD).getRange("A12").setValues(A),A=c.getRange("A14").getValues(),r.getSheetByName(ABAS.DASHBOARD).getRange("A14").setValues(A),A=c.getRange("A16").getValues(),r.getSheetByName(ABAS.DASHBOARD).getRange("A16").setValues(A),A=c.getRange("A18").getValues(),r.getSheetByName(ABAS.DASHBOARD).getRange("A18").setValues(A),A=c.getRange("A20").getValues(),r.getSheetByName(ABAS.DASHBOARD).getRange("A20").setValues(A),A=c.getRange("A22").getValues(),r.getSheetByName(ABAS.DASHBOARD).getRange("A22").setValues(A),A=c.getRange("A24").getValues(),r.getSheetByName(ABAS.DASHBOARD).getRange("A24").setValues(A),A=c.getRange("A27").getValues(),r.getSheetByName(ABAS.DASHBOARD).getRange("A27").setValues(A),A=c.getRange("A29").getValues(),r.getSheetByName(ABAS.DASHBOARD).getRange("A29").setValues(A),A=c.getRange("A31").getValues(),r.getSheetByName(ABAS.DASHBOARD).getRange("A31").setValues(A),c=g.getSheetByName(ABAS.BENS_DIREITOS),A=c.getRange("AC2").getValues(),r.getSheetByName(ABAS.BENS_DIREITOS).getRange("AC2").setValues(A),s.getRange("D6").setValue(!0),s.getRange("E6").setValue("1/1"),c=g.getSheetByName(ABAS.DARF),A=c.getRange("C18:C23").getValues(),r.getSheetByName(ABAS.DARF).getRange("C18:C23").setValues(A),c=g.getSheetByName(ABAS.DARF),A=c.getRange("K18:K24").getValues(),r.getSheetByName(ABAS.DARF).getRange("k18:k24").setValues(A),s.getRange("D7").setValue(!0),s.getRange("E7").setValue("7/7")),copyData(s,"D8",1,4,2,2,"E8",ABAS.VENDAS,g,r,2,!0,e),copyData(s,"D8",1,4,8,6,"E8",ABAS.VENDAS,g,r,2,!1,e),copyData(s,"D9",1,2,2,4,"E9",ABAS.MEUS_OBJETIVOS,g,r,2,!1,e),copyData(s,"D10",1,4,2,1,"E10",ABAS.PRECO_TETO,g,r,2,!0,e),copyData(s,"D10",1,4,7,2,"E10",ABAS.PRECO_TETO,g,r,2,!1,e),copyData(s,"D11",2,4,8,3,"E11",ABAS.SIMULADOR_PM,g,r,2,!1,e),copyData(s,"D12",2,4,2,1,"E12",ABAS.BALANCEAMENTO_ATIVO,g,r,2,!0,e),copyData(s,"D12",2,4,7,1,"E12",ABAS.BALANCEAMENTO_ATIVO,g,r,2,!1,e),copyData(s,"D13",2,4,2,1,"E13",ABAS.BALANCEAMENTO,g,r,2,!0,e),copyData(s,"D13",2,4,7,1,"E13",ABAS.BALANCEAMENTO,g,r,2,!0,e),!1===s.getRange("D13").getValue()&&2===e&&(c=g.getSheetByName(ABAS.BALANCEAMENTO),l=c.getLastRow(),A=c.getRange(4,2,l,1).getValues(),u=l-A.reverse().findIndex((e=>""!=e[0])),c=g.getSheetByName(ABAS.BALANCEAMENTO),l=c.getLastRow(),A=c.getRange("U18").getValues(),r.getSheetByName(ABAS.BALANCEAMENTO).getRange("U18").setValues(A),s.getRange("D13").setValue(!0),s.getRange("E13").setValue(`${u}/${u}`)),copyData(s,"D14",2,2,1,3,"E14",ABAS.AMORTIZACOES,g,r,1,!1,e),copyData(s,"D15",2,4,2,4,"E15",ABAS.PROVENTOS,g,r,2,!0,e),copyData(s,"D15",2,4,7,3,"E15",ABAS.PROVENTOS,g,r,2,!1,e),copyData(s,"D16",3,2,4,2,"E16",ABAS.EVOLUCAO_PATRIMONIAL,g,r,4,!0,e),copyData(s,"D16",3,2,7,1,"E16",ABAS.EVOLUCAO_PATRIMONIAL,g,r,4,!1,e),copyData(s,"D17",3,2,3,9,"E17",ABAS.LANCAMENTO_CDB,g,r,2,!1,e),copyData(s,"D18",3,2,3,3,"E18",ABAS.LANCAMENTO_MANUAL,g,r,3,!0,e),copyData(s,"D18",3,2,8,4,"E18",ABAS.LANCAMENTO_MANUAL,g,r,3,!0,e),copyData(s,"D18",3,2,16,1,"E18",ABAS.LANCAMENTO_MANUAL,g,r,3,!0,e),copyData(s,"D18",3,2,18,2,"E18",ABAS.LANCAMENTO_MANUAL,g,r,3,!1,e),copyData(s,"D19",3,2,3,3,"E19",ABAS.LANCAMENTO_B3,g,r,3,!0,e),copyData(s,"D19",3,2,9,4,"E19",ABAS.LANCAMENTO_B3,g,r,3,!0,e),copyData(s,"D19",3,2,16,1,"E19",ABAS.LANCAMENTO_B3,g,r,3,!0,e),copyData(s,"D19",3,2,18,2,"E19",ABAS.LANCAMENTO_B3,g,r,3,!1,e),!0===s.getRange("D5").getValue()&&!0===s.getRange("D6").getValue()&&!0===s.getRange("D7").getValue()&&!0===s.getRange("D8").getValue()&&!0===s.getRange("D9").getValue()&&!0===s.getRange("D10").getValue()&&!0===s.getRange("D12").getValue()&&!0===s.getRange("D13").getValue()&&!0===s.getRange("D14").getValue()&&!0===s.getRange("D15").getValue()&&!0===s.getRange("D16").getValue()&&!0===s.getRange("D17").getValue()&&!0===s.getRange("D18").getValue()&&!0===s.getRange("D19").getValue()&&n.alert("Lan√ßamentos importados com sucesso! O √∫ltimo passo √© ir a aba '0. Dashboard' e acionar o bot√£o 'Atualizar Cota√ß√£o'\n\n Bons investimentos!\n@ricardoinvesting"),n.showSidebar(a.setTitle(t))}catch(e){throw n.showSidebar(a.setTitle(t)),new Error(`N√£o foi poss√≠vel copiar os dados. ::erro!:: ${e}`)}}function fase1(){importDataOtherVersion(1)}function fase2(){importDataOtherVersion(2)}function fase3(){importDataOtherVersion(3)}function showReleases(){try{const e="LAN√áAMENTOS",t=SpreadsheetApp.getUi(),a=HtmlService.createTemplateFromFile("@ricardoinvesting-lancamentos").evaluate();t.showSidebar(a.setTitle(e))}catch(e){throw new Error(`N√£o foi poss√≠vel carregar o formul√°rio. ::erro!:: ${e}`)}}function saveInput(e="MXRF11",t="01/01/2024",a="Compra",n=null,o=0,r=0,s=0,i=0,g=0,c=0,A=null){try{if(!A||!A.hasOwnProperty("classe"))throw new Error("Detalhe do ticker n√£o informado");const u=SpreadsheetApp.getActiveSpreadsheet(),l=[...CLASS_EXTERNAL_LIST,CLASS.CRIPTOMOEDA],S=`${t.split("-")[2]}/${t.split("-")[1]}/${t.split("-")[0]}`;if(a===OPERATIONS.VENDA||a===OPERATIONS.VENDA_DIREITOS){const t=SpreadsheetApp.getActiveSpreadsheet().getSheetByName(ABAS.VENDAS),a=getLastRowInTable(t,"B",4)+1;t.getRange(`B${a}`).setValue(e),t.getRange(`C${a}`).setValue(n),t.getRange(`H${a}`).setValue(o),t.getRange(`I${a}`).setValue(s),t.getRange(`J${a}`).setValue(i),t.getRange(`K${a}`).setValue(g),t.getRange(`L${a}`).setValue(c),t.getRange(`M${a}`).setValue(S)}if(!l.includes(A.classe)){const t=u.getSheetByName(ABAS.LANCAMENTO_B3),n=getLastRowInTable(t,"C",2)+1;t.getRange(`C${n}`).setValue(e),t.getRange(`D${n}`).setValue(S),t.getRange(`E${n}`).setValue(a),t.getRange(`I${n}`).setValue(o),a===OPERATIONS.VENDA||a===OPERATIONS.VENDA_DIREITOS?t.getRange(`J${n}`).setValue(i):t.getRange(`J${n}`).setValue(r),t.getRange(`K${n}`).setValue(g),t.getRange(`L${n}`).setValue(c)}return!0}catch(e){throw new Error(`N√£o foi poss√≠vel enviar os lan√ßamentos. ::erro!:: ${e}`)}}function saveProvent(e="MXRF11",t="01/01/2024",a="Rendimento",n=0,o=0,r=0,s=0,i=null){try{if(!i||!i.hasOwnProperty("classe"))throw new Error("Detalhe do ticker n√£o informado");const g=SpreadsheetApp.getActiveSpreadsheet(),c=[...CLASS_EXTERNAL_LIST,CLASS.CRIPTOMOEDA],A=`${t.split("-")[2]}/${t.split("-")[1]}/${t.split("-")[0]}`,u=g.getSheetByName(ABAS.PROVENTOS),l=getLastRowInTable(u,"B",4)+1;return u.getRange(`B${l}`).setValue(e),u.getRange(`C${l}`).setValue(a),u.getRange(`D${l}`).setValue(A),u.getRange(`E${l}`).setValue(n),u.getRange(`G${l}`).setValue(o),u.getRange(`H${l}`).setValue(r),c.includes(i.classe)&&u.getRange(`I${l}`).setValue(s),!0}catch(e){throw new Error(`N√£o foi poss√≠vel enviar os lan√ßamentos. ::erro!:: ${e}`)}}function calcPMFull(e=""){try{const e=0,t=SpreadsheetApp.getActiveSpreadsheet(),a=getDataRange(t.getSheetByName(ABAS.MOVIMENTACOES),"C",2,"A",2,"V"),n=[],o={};for(let t=e;t<=a.length-1;t++){const e=a[t][2],r=new Date(a[t][3]).toISOString();n.includes(e)?o[e].movimentations.push({data:r,typeOperation:a[t][4],qtd:a[t][5],investedAmount:a[t][9]}):(o[e]={movimentations:[{data:r,typeOperation:a[t][4],qtd:a[t][5],investedAmount:a[t][9]}]},n.push(e))}const r={extension:{}};return Object.keys(o).forEach((e=>{const t=o[e].movimentations.sort(((e,t)=>e.data<t.data?-1:e.data>t.data?1:0)),a={};t.forEach((function(e){const t=a[e.data];t?t.push(e):a[e.data]=[e]}));const n=Object.keys(a);let s=0,i=0,g=null;n.forEach((e=>{a[e].forEach((e=>{const t=e.typeOperation,a=e.qtd,n=e.investedAmount;if(t===OPERATIONS.BONIFICACAO||t===OPERATIONS.COMPRA||t===OPERATIONS.COMPRA_DIREITOS)i+=n,s+=a;else if(t===OPERATIONS.VENDA||t===OPERATIONS.VENDA_DIREITOS){const t=i/s,n=s-a;if(0===n){const t=new Date(e.data).getFullYear();let a=new Date(e.data).getMonth();a=a>8?a+1:`0${a+1}`,g=`${t}${a}`}i=t*n,s=n}}))})),r.extension[e]={lastDateFinishPosition:g},r[e]=i&&s?i/s:0})),JSON.stringify(r)}catch(e){return"-"}}function getPM(e,t){try{const a=JSON.parse(e);if(t in a)return a[t]}catch{return"-"}}function getExtensionData(e,t,a){try{const n=JSON.parse(e);if(t in n.extension)return n.extension[t][a]}catch{return"-"}}